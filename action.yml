name: 'git gen'
description: 'Generate code from feature descriptions using git context'
branding:
  icon: 'git-branch'
  color: 'orange'

inputs:
  feature:
    description: 'Feature description to generate'
    required: true
  branch:
    description: 'Branch name (optional, auto-generated if not provided)'
    required: false
  dry-run:
    description: 'Show plan without generating files'
    required: false
    default: 'false'
  provider:
    description: 'LLM provider: anthropic, bedrock, openrouter'
    required: false
    default: 'anthropic'
  model:
    description: 'Model alias or ID (e.g., claude-sonnet, claude-opus)'
    required: false

  # Provider-specific keys
  anthropic-api-key:
    description: 'Anthropic API key (for provider: anthropic)'
    required: false
  openrouter-api-key:
    description: 'OpenRouter API key (for provider: openrouter)'
    required: false
  aws-access-key-id:
    description: 'AWS Access Key ID (for provider: bedrock)'
    required: false
  aws-secret-access-key:
    description: 'AWS Secret Access Key (for provider: bedrock)'
    required: false
  aws-region:
    description: 'AWS Region (for provider: bedrock)'
    required: false
    default: 'us-east-1'

outputs:
  branch:
    description: 'Branch name where files were generated'
    value: ${{ steps.gen.outputs.branch }}
  files:
    description: 'List of generated files'
    value: ${{ steps.gen.outputs.files }}

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install gitgen
      shell: bash
      run: npm install -g gitgen

    - name: Generate
      id: gen
      shell: bash
      env:
        GITGEN_PROVIDER: ${{ inputs.provider }}
        GITGEN_MODEL: ${{ inputs.model }}
        ANTHROPIC_API_KEY: ${{ inputs.anthropic-api-key }}
        OPENROUTER_API_KEY: ${{ inputs.openrouter-api-key }}
        AWS_ACCESS_KEY_ID: ${{ inputs.aws-access-key-id }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws-secret-access-key }}
        AWS_REGION: ${{ inputs.aws-region }}
      run: |
        ARGS=""
        if [ -n "${{ inputs.branch }}" ]; then
          ARGS="-b ${{ inputs.branch }}"
        fi
        if [ "${{ inputs.dry-run }}" = "true" ]; then
          ARGS="$ARGS --dry-run"
        fi

        git gen $ARGS "${{ inputs.feature }}" | tee output.txt

        # Extract branch name
        BRANCH=$(git branch --show-current)
        echo "branch=$BRANCH" >> $GITHUB_OUTPUT

        # Extract generated files
        FILES=$(grep -E '^\s+\+' output.txt | sed 's/^\s*+ //' | tr '\n' ' ' || echo "")
        echo "files=$FILES" >> $GITHUB_OUTPUT
