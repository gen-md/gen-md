# Fork a public repo, analyze it, and create a PR with .gitgen.md
#
# Setup: Add these secrets to your GitHub account (Settings > Secrets > Actions):
#   - ANTHROPIC_API_KEY (Anthropic)
#   - OPENAI_API_KEY (OpenAI)
#   - OPENROUTER_API_KEY (OpenRouter - has free tier)
#   - GOOGLE_GENERATIVE_AI_API_KEY (Google AI)
#   - AWS_ACCESS_KEY_ID + AWS_SECRET_ACCESS_KEY (AWS Bedrock)
#
# These secrets work across all your repos once set at the account level.

name: Fork & Learn

on:
  workflow_dispatch:
    inputs:
      repo:
        description: 'Repository to fork (owner/repo)'
        required: true
        type: string
      prompt:
        description: 'Custom instructions for learning (optional)'
        required: false
        type: string
      provider:
        description: 'LLM Provider'
        required: false
        type: choice
        options:
          - openrouter
          - anthropic
          - openai
          - google
          - bedrock
        default: openrouter

jobs:
  fork-and-learn:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Parse repository
        id: parse
        run: |
          REPO="${{ inputs.repo }}"
          OWNER=$(echo $REPO | cut -d'/' -f1)
          NAME=$(echo $REPO | cut -d'/' -f2)
          echo "owner=$OWNER" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: Fork repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh repo fork ${{ inputs.repo }} --clone=false || true
          sleep 5  # Wait for fork to be ready

      - name: Clone fork
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh repo clone ${{ github.actor }}/${{ steps.parse.outputs.name }}
          cd ${{ steps.parse.outputs.name }}
          git remote add upstream https://github.com/${{ inputs.repo }}.git

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure git
        working-directory: ${{ steps.parse.outputs.name }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch
        working-directory: ${{ steps.parse.outputs.name }}
        run: |
          git checkout -b gitgen-spec

      - name: Run git gen learn
        working-directory: ${{ steps.parse.outputs.name }}
        env:
          GITGEN_PROVIDER: ${{ inputs.provider }}
          # Anthropic
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # OpenAI
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # Google AI
          GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
          # OpenRouter (free tier available)
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          # AWS Bedrock
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
        run: |
          if [ -n "${{ inputs.prompt }}" ]; then
            npx gitgen learn --prompt "${{ inputs.prompt }}"
          else
            npx gitgen learn
          fi

      - name: Commit and push
        working-directory: ${{ steps.parse.outputs.name }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add .gitgen.md
          git commit -m "Add .gitgen.md specification"
          git push -u origin gitgen-spec

      - name: Create PR to upstream
        working-directory: ${{ steps.parse.outputs.name }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --repo ${{ inputs.repo }} \
            --title "Add .gitgen.md specification" \
            --body "## Summary

          This PR adds a \`.gitgen.md\` specification file generated by [gitgen](https://github.com/gitgen/gitgen).

          The spec captures:
          - Project patterns and conventions
          - Tech stack detection
          - Directory structure
          - Coding style guidelines

          ## What is gitgen?

          gitgen is a CLI tool that generates code matching your codebase patterns.

          With this \`.gitgen.md\` file, contributors can use:
          \`\`\`bash
          npx gitgen \"add new feature\"
          \`\`\`

          to generate code that matches your project's style.

          ---
          Generated with [gitgen](https://github.com/gitgen/gitgen)"

      - name: Summary
        run: |
          echo "## Fork & Learn Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Source repo:** ${{ inputs.repo }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Your fork:** https://github.com/${{ github.actor }}/${{ steps.parse.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** gitgen-spec" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A pull request has been created to the upstream repository." >> $GITHUB_STEP_SUMMARY
