# Generate features with gitgen - copy to your repo's .github/workflows/
#
# Setup: Add these secrets to your GitHub account (Settings > Secrets > Actions):
#   - ANTHROPIC_API_KEY (Anthropic)
#   - OPENAI_API_KEY (OpenAI)
#   - OPENROUTER_API_KEY (OpenRouter - has free tier)
#   - GOOGLE_GENERATIVE_AI_API_KEY (Google AI)
#   - AWS_ACCESS_KEY_ID + AWS_SECRET_ACCESS_KEY (AWS Bedrock)
#
# These secrets work across all your repos once set at the account level.

name: git gen

on:
  workflow_dispatch:
    inputs:
      feature:
        description: 'Feature to generate'
        required: true
        type: string
      branch:
        description: 'Branch name (optional)'
        required: false
        type: string
      provider:
        description: 'LLM Provider'
        required: false
        type: choice
        options:
          - openrouter
          - anthropic
          - openai
          - google
          - bedrock
        default: openrouter

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 20  # Need history for context

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch
        id: branch
        run: |
          BRANCH="${{ inputs.branch }}"
          if [ -z "$BRANCH" ]; then
            BRANCH="gitgen/$(echo '${{ inputs.feature }}' | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | head -c 50)"
          fi
          echo "name=$BRANCH" >> $GITHUB_OUTPUT
          git checkout -b "$BRANCH"

      - name: Generate feature
        env:
          GITGEN_PROVIDER: ${{ inputs.provider }}
          # Anthropic
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # OpenAI
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # Google AI
          GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
          # OpenRouter (free tier available)
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          # AWS Bedrock
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
        run: |
          npx gitgen "${{ inputs.feature }}"

      - name: Commit and push
        run: |
          git add .
          git commit -m "feat: ${{ inputs.feature }}" || echo "No changes to commit"
          git push -u origin ${{ steps.branch.outputs.name }}

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "feat: ${{ inputs.feature }}" \
            --body "## Summary

          Generated by [gitgen](https://github.com/gitgen/gitgen)

          **Feature:** ${{ inputs.feature }}
          **Provider:** ${{ inputs.provider }}

          ---
          Generated with \`npx gitgen\`"
