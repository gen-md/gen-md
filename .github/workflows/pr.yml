name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  validate-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Check for .gitgen.md changes
        id: spec-changes
        run: |
          if git diff --name-only origin/main...HEAD | grep -q '\.gitgen\.md$'; then
            echo "specs_changed=true" >> $GITHUB_OUTPUT
          else
            echo "specs_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate changed specs
        if: steps.spec-changes.outputs.specs_changed == 'true'
        run: |
          node dist/index.js init
          node dist/index.js validate

      - name: Check commit messages
        run: |
          # Validate conventional commit format
          git log origin/main..HEAD --pretty=format:"%s" | while read -r msg; do
            if ! echo "$msg" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+'; then
              echo "::warning::Commit message does not follow conventional commits: $msg"
            fi
          done

  size-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Check bundle size
        run: |
          SIZE=$(du -sk dist | cut -f1)
          echo "Build size: ${SIZE}KB"
          if [ "$SIZE" -gt 1024 ]; then
            echo "::warning::Build size exceeds 1MB (${SIZE}KB)"
          fi

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          allow-licenses: MIT, ISC, Apache-2.0, BSD-2-Clause, BSD-3-Clause
